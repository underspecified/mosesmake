#!/bin/bash

moses_cp_data () {	
	mkdir -p $system $corpus_dir $lm_dir $model_dir $tuning_dir $eval_dir
	cp -f $training_src_file $train_stem.$src
	cp -f $training_tgt_file $train_stem.$tgt
	cp -f $dev_src_file $tuning_in_stem
	cp -f $dev_tgt_file $tuning_ref_stem
	cp -f $test_src_file $eval_in_stem
	cp -f $test_tgt_file $eval_ref_stem
	cp -f $lm_file $lm_stem

	echo '#' find $system
	find $system | sort
}

usage () {
	echo 'usage: moses_all [-s|--src en|es|ja] [-t|--tgt en|es|ja] [-r|--root <root_dir>] [-c|--corpus <corpus_name>] [-l|--lm-corpus <lm_corpus_file>] [-f|--factors <factors>] [-b|--baseline <baseline_output>] <training_src_file> <training_tgt_file> <dev_src_file> <dev_tgt_file> <test_src_file> <test_tgt_file> <lm_file>' 1>&2
	exit 1
}

echo moses_all $* > command.tmp

export root=$(pwd)
export factors=factorless
export baseline=''
while [ $# -gt 0 -a "${1#-}" != "$1" ]; do
	case $1 in
		-b|--baseline)
			export baseline=$2
			shift 2
		;;
		-c|--corpus)
			export corpus=$2
			shift 2
		;;
		-f|--factors)
			export factors=$2
			shift 2
		;;
		-l|--lm-corpus)
			export lm_corpus=$2
			shift 2
		;;
		-r|--root)
			export root=$2
			shift 2
		;;
		-s|--src)
			export src=$2
			shift 2
		;;		
		-t|--tgt)
			export tgt=$2
			shift 2
		;;
		*)
			echo malformed flag $1 ! 1>&2
			usage
			exit 1
		;;
	esac
done

if [ -z "$src" -o -z "$tgt" -o -z "$corpus" -o -z "$lm_corpus" -o -z "$factors" -o -z "$root" ]; then
	echo '$src, $tgt, $corpus, $lm_corpus, $factors, and $root must be set!' 1>&2
	usage
	exit 1
fi

. $MHOME/env/moses.env

export tlog=$system/time.log.$$
time_log () {
	echo $(date) >> $tlog
	/usr/bin/time -a -o $tlog $*
}

mkdir -p $system
mv command.tmp $system/command.txt
rm -f $tlog && touch $tlog

echo "corpus=$corpus" > $system/command.env
echo "lm_corpus=$lm_corpus" >> $system/command.env
echo "factors=$factors" >> $system/command.env
echo "root=$root" >> $system/command.env
echo "src=$src" >> $system/command.env
echo "tgt=$tgt" >> $system/command.env
if [ -n "$baseline" ]; then
	echo "baseline=$baseline" >> $system/command.env
fi

case $# in
	7)
		export training_src_file=$1
		export training_tgt_file=$2
		export dev_src_file=$3
		export dev_tgt_file=$4
		export test_src_file=$5
		export test_tgt_file=$6
		export lm_file=$7
		
#		env | sort 
		
		if [ -s $training_src_file -a -s $training_tgt_file -a \
		     -s $dev_src_file -a -s $dev_tgt_file -a \
			 -s $test_src_file -a -s $test_tgt_file -a -s $lm_file ]; then
			. $MHOME/env/moses.env
			moses_cp_data
			time_log moses_prepare_data
		   	time_log moses_build_lm
			time_log moses_train_am
			time_log moses_evaluate
		   	time_log moses_tune_am
			time_log moses_evaluate --mert
		else
			echo necessary files don\'t exist! 1>&2
			usage
			exit 1
		fi
	;;	
	*)
		echo missing necessary arguments! 1>&2
		usage
		exit 1
	;;
esac
