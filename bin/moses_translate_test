#!/usr/local/plan9/bin/rc

fn moses_setup {
	src=ja
	tgt=es
	pair=$src-$tgt
	root=/work2/eric-n/research/smt/moses
	data=test2007
	system=$root/$data/$pair
	training_dir=$system/training
	corpus_dir=$system/corpus
	lm_dir=$system/lm
	training=$training_dir/$data
	tokenized=$corpus_dir/$data.tok
	clean=$corpus_dir/$data.clean
	lowercased=$corpus_dir/$data.lowercased
	min=1
	max=40
	lm_dir = $system/lm
	lm_data = europarl-v3
	lm_tokenized = $lm_dir/$lm_data.tok
	lm_lowercased = $lm_dir/$lm_data.lowercased
	lm = $lm_dir/$lm_data.lm
	tuning_dir = $system/tuning
	tuning_data = test2007.dev
	input_file = /work2/eric-n/research/smt/moses/europarl/test2007.dev.ja.txt
	input_tokenized = $tuning_dir/$tuning_data.input.tok
	input = $tuning_dir/$tuning_data.input
	ref_file = /work2/eric-n/research/smt/moses/europarl/test2007.dev.es.txt
	ref_tokenized = $tuning_dir/$tuning_data.reference.tok
	ref = $tuning_dir/$tuning_data.reference
	model_dir = $system/model
}

fn moses_tune_am {
	echo -n Setting up ...
	moses_setup
	echo done.

	echo -n Tokenizing ...
	{ moses_tokenize $src } < $ref_file > $ref_tokenized
	{ moses_tokenize $tgt } < $input_file > $input_tokenized
	echo done.
	
	echo -n Converting to lowercase ...
	moses_lowercase < $input_tokenized > $input
	moses_lowercase < $ref_tokenized > $ref
	echo done.
	
	filter-model-given-input.pl working-dir/evaluation/filtered.devtest2006 working-dir/tuning/moses.weight-reused.ini working-dir/evaluation/devtest2006.input
	
	moses -config working-dir/evaluation/filtered.devtest2006/moses.ini -input-file working-dir/evaluation/devtest2006.input > working-dir/evaluation/devtest2006.output
}
