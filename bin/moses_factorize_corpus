#!/usr/local/plan9/bin/rc

fn eos_record2line {
	awk '
	BEGIN {
		RS = "EOS"
		ORS = ""
	}
	{
		for (i=1; i<=NF; i++) {
			printf "%s ", $i
		}
		print "\n"
	}' |
	head -n -1
}

fn moses_factorize_corpus_ja {
	tr -d ' ' |
	mecab8 -F'%m|%M|%F-[0,1]|%F-[4,5]___' |
	sed 's/___/ /g
		 s/| /|NULL /g
		 s/EOS$//g'
}

fn protect_char {
	sed 's/$1/*CHAR*/g'
}

fn restore_char {
	sed 's/*CHAR*/$1/g'
}

fn moses_fact2tok_pos {
	moses_fact2tok+pos |
	protect_char '|' |
	tr '|' '_'
}

fn moses_tok_pos2morph {
	morpha -a |
	awk '
	{
		for (i=1; i<=NF; i++) {
			num = split($i, data, "+")
			if (num == 2)
				$i = "+" data[2]
			else
				$i = "NULL"
		}
		print
	}' |
	restore_char '|'
}

fn moses_add_morph_en {
	tee tmp.fact.$pid |
	moses_fact2tok_pos |
	moses_tok_pos2morph > tmp.morph.$pid
	paste tmp.fact.$pid tmp.morph.$pid |
	awk '
	BEGIN {
		FS = "\t"
	}
	{
		ilen = split($1, itoks, " ")
		jlen = split($2, jtoks, " ")
		if (ilen != jlen) {
			printf "ERROR: line %s: %d != %d", NR, ilen, jlen
			exit 1
		}
		
		for (i=1; i<=ilen; i++) {
			printf "%s|%s ", itoks[i], jtoks[i]
		}
		print ""
	}'
	rm -f tmp.*.$pid
}

fn moses_factorize_corpus_en {
	tag_with_eos tree-tagger-english >[2=] |
	awk '
	BEGIN {
		FS = "\t"
		OFS = "|"
	}
	NF >= 3 {
		surface = $1
		pos = $2
#		morph = $2
		lemma = $3
#		print surface, lemma, pos, morph
		print surface, lemma, pos
	}
	/^EOS$/' |
	eos_record2line |
	moses_add_morph_en
}

fn moses_factorize_corpus {
	lang = $1
	switch($lang) {
		case en
			moses_factorize_corpus_en
		case ja
			moses_factorize_corpus_ja
	}
}

switch($#*) {
	case 1
		moses_factorize_corpus $1
	case *
		echo usage: moses_factorize_corpus language >[1=2]
		exit 1
}
