#!/usr/local/plan9/bin/rc

fn moses_fact2tok+pos {
	awk '
	BEGIN {
		surface = 1
		lemma = 2
		pos = 3
		morph = 4
	}
	{
		sent = ""
		for (i=1; i<=NF; i++) {
			split($i, data, "|")
			sent = sent data[surface] "_" data[pos] " "
			items[i,surface] = data[surface]
			items[i,lemma] = data[lemma]
			items[i,pos] = data[pos]
		}
		
		gsub("\"", "\\\"", sent)
		("echo \"" sent "\" | morpha -a") | getline msent
		close("echo \"" sent "\" | morpha -a")
		
		mlen = split(msent, mtoks, " ")
		for (j=1; j<=mlen; j++) {
			mnum = split(mtoks[j], mdata, "+")
			if (mnum == 2) {
				items[j,morph] = "+" mdata[2]
			}
			else {
				items[j,morph] = "*"
			}
		}
		
		for (i=1; i<=NF; i++) {
			printf "%s|%s|%s|%s ", items[i,surface], items[i,lemma], items[i,pos], items[i,morph]
		}
		print ""
	}'
}

moses_fact2tok+pos
